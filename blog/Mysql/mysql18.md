# MYSQL核心技术总结


> Mysql  **幻读**

- 幻读 ： 幻读指的是一个事务在前后两次查询同一个范围的时候，后一次查询看到了前一次查询没有看到的行。**幻读仅专指“新插入的行”**，刚修改的行被再次读取到不是幻读。

- 当前读-快照读 ： 在可重复读隔离级别下，普通的查询是快照读，是不会看到别的事务插入的数据的。当前读的规则，就是要能读到所有已经提交的记录的最新值。因此，幻读在“当前读”下才会出现，例如下：
```
select * from a for update
```

- 即使把所有的记录都加上锁，还是阻止不了新插入的记录，这也是为什么“幻读”会被单独拿出来解决的原因。

- 产生幻读的原因是，行锁只能锁住行，但是新插入记录这个动作，要更新的是记录之间的“间隙”。因此，为了解决幻读问题，InnoDB 只好引入新的锁，也就是间隙锁 (Gap Lock)。顾名思义，间隙锁，锁的就是两个值之间的空隙。

- 当你执行 select * from t where d=5 for update 的时候，就不止是给数据库中已有的 6 个记录加上了行锁，还同时加了 7 个间隙锁。**这样就确保了无法再插入新的记录**。也就是说这时候，在一行行扫描的过程中，不仅将给行加上了行锁，还给行两边的空隙，也加上了间隙锁。

- 跟间隙锁存在冲突关系的，是“往这个间隙中插入一个记录”这个操作。间隙锁之间都不存在冲突关系。

- 间隙锁的引入，可能会导致同样的语句锁住更大的范围，这其实是影响了并发度的。

- 间隙锁是在可重复读隔离级别下才会生效的。所以，你如果把隔离级别设置为读提交的话，就没有间隙锁了。但同时，你要解决可能出现的数据和日志不一致问题，需要把 binlog 格式设置为 row。这，也是现在不少公司使用的配置组合。
