# MYSQL核心技术总结


> Mysql **为什么表数据删掉一半，表文件大小不变？**

- 每个 InnoDB 表数据存储在一个以 .ibd 为后缀的文件中。

- delete 命令其实只是把记录的位置，或者数据页标记为了 **“可复用”** ，但磁盘文件的大小是不会变的。也就是说，通过 delete 命令是不能回收表空间的。这些可以复用，而没有被使用的空间，看起来就像是“空洞”。

- 不止是删除数据会造成空洞，插入数据也会。如果数据是按照索引递增顺序插入的，那么索引是紧凑的。但如果数据是随机插入的，就可能造成索引的数据页分裂。

- 更新索引上的值，可以理解为删除一个旧的值，再插入一个新值。不难理解，这也是会造成空洞的。

- 也就是说，经过大量增删改的表，都是可能是存在空洞的。所以，如果能够把这些空洞去掉，就能达到收缩表空间的目的。**而重建表，就可以达到这样的目的**。

- 可以使用 **alter table A engine=InnoDB** 命令来重建表。在 MySQL 5.5 版本之前，这个命令的执行流程跟我们前面描述的差不多，区别只是这个临时表 B 不需要你自己创建，MySQL 会自动完成转存数据、交换表名、删除旧表的操作。

- 花时间最多的步骤是往临时表插入数据的过程，如果在这个过程中，有新的数据要写入到表 A 的话，就会造成 **数据丢失**。因此，在整个 DDL 过程中，表 A 中不能有更新。也就是说，**这个 DDL 不是 Online 的**。

- MySQL 5.6 版本开始引入的 Online DDL，对这个操作流程做了优化。

    >流程：
      1. 建立一个临时文件，扫描表 A 主键的所有数据页；
      2. 用数据页中表 A 的记录生成 B+ 树，存储到临时文件中；生成临时文件的过程中，将所有对 A 的操作记录在一个日志文件（row log）中，对应的是图中 state2 的状态；
      3. 临时文件生成后，将日志文件中的操作应用到临时文件，得到一个逻辑数据上与表 A 相同的数据文件，对应的就是图中 state3 的状态；用临时文件替换表 A 的数据文件。
