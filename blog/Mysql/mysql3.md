# MYSQL核心技术总结



> Mysql **事务**

- 隔离性ACID：原子性，一致性，隔离性，持久性。

- 隔离级别：读未提交，读已提交，可重复读，串行化。Oracle默认读已提交，Mysql默认可重复读。

- 多事务问题：脏读，不可重复读，幻读。

    - *脏读* ：
    当数据库中一个事务A正在修改一个数据但是还未提交或者回滚，
    另一个事务B 来读取了修改后的内容并且使用了，
        之后事务A提交了，此时就引起了脏读。

    此情况仅会发生在： 读未提交的的隔离级别.

    - *不可重复读* ：
    在一个事务A中多次操作数据，在事务操作过程中(未最终提交)，
    事务B也才做了处理，并且该值发生了改变，这时候就会导致A在事务操作
    的时候，发现数据与第一次不一样了。 就是不可重复读。

    此情况仅会发生在：读未提交、读提交的隔离级别.

    - *幻读* ：
    一个事务按相同的查询条件重新读取以前检索过的数据，
    却发现其他事务插入了满足其查询条件的新数据，这种现象就称为幻读。

    幻读是指当事务不是独立执行时发生的一种现象，例如第一个事务对一个表中的数据进行了修改，比如这种修改涉及到表中的“全部数据行”。同时，第二个事务也修改这个表中的数据，这种修改是向表中插入“一行新数据”。那么，以后就会发生操作第一个事务的用户发现表中还存在没有修改的数据行，就好象发生了幻觉一样.
    一般解决幻读的方法是增加范围锁RangeS，锁定检索范围为只读，这样就避免了幻读。

    此情况会回发生在：读未提交、读提交、可重复读的隔离级别.

- 视图：读已提交和可重复读使用视图来实现，读已提交在每个SQL开始执行的时候创建，可重复读是在事务启动时创建。读未提交直接返回记录上的最新值，没有视图概念，串行化用加锁的方式避免并行访问。

- 设置隔离级别
```

  mysql> show variables like 'transaction_isolation';

  +-----------------------+----------------+

  | Variable_name | Value |

  +-----------------------+----------------+

  | transaction_isolation | READ-COMMITTED |

  +-----------------------+----------------+
```
- 隔离级别实现  多版本并发控制（MVCC）：每条记录在更新的时候都会产生一条回滚操作，查询这条记录的时候，不同时刻启动的事务会有不同的read-view，也就是说同一条数据在系统中可能存在多个版本。

- 事务启动方式
    - 显式启动：begin或者start transaction，提交commit，回滚rollback。

    - set autocommit=0，关闭自动提交，执行select语句开启事务直到执行commit，rollback或者断开连接。

    - 对于一个需要频繁使用事务的业务，每次都要使用begin语句比较麻烦，可以使用commit work and chain语句，提交后自动开启下一个事务。

    - 查询长事务:
    ```
    select * from information_schema.innodb_trx where TIME_TO_SEC(timediff(now(),trx_started))>60
    ```
