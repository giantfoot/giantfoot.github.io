#### 集群环境搭建(主从复制)


主从复制，是指将已一台Redis服务器的数据，复制到其他的Redis服务器。前者称为主节点，后者称为从节点，数据的复制是单向的，只能从主节点到从节点。因为服务器的压力主要来自读请求，所以可以设置为Master以写为主，Slave以读为主。


主从复制主要作用：

- 数据冗余：主从复制实现了数据的热备份，持久化之外的一种数据冗余方式，
- 故障恢复：当主节点出现问题，可有从节点提供服务，实现快速故障恢复；实际上是一种服务的冗余。
- 负载均衡：在主从复制的基础上，配合读写分离，可以由主节点写提供服务，由从节点提供度服务，分担服务器负载；尤其是在写少读多的场景下，通过多个从节点分担读负载，可以大大提高redis服务器的并发量。
- 高可用： 主从复制是哨兵和集群能够实施的基础，也是redis高可用的基础。

环境配置：

只用配置从库，默认启动就是主库。
```
info replication  #查看当前服务的信息
```


复制多个redis.conf
```
主服务配置
logfile "6379.log"  #配置日志文件
dbfilename  dump6379.rdb  #配置RDB持久化文件

从服务配置
port 6380
当Redis以守护进程方式运行时，Redis默认会把pid写入/var/run/redis.pid文件，可以通过pidfile指定,用cat命令查看，可以看到内容只有一行，记录了该进程的ID,防止启动多个进程副本,进程运行后会给.pid文件加一个文件锁，只有获得该锁的进程才有写入权限（F_WRLCK），把自身的pid写入该文件中。
其他试图获得该锁的进程会自动退出。
pidfile /var/run/redis_6380.pid
logfile "6380.log"
dbfilename  dump6380.rdb

```

单机伪集群

```
redis-server redis.conf
```

**目前所有启动的服务都是Master，因为还没配置主从复制，现在只用配置从机就可以了，只做一个动作，让从机找到它的老大即可。**

方式一：在从机服务器上执行,命令形式，不是永久的
```
slaveof 127.0.0.1 6379
```

方式二：修改配置，永久配置
```
修改从机配置文件
replicaof  masterip port
如果主机有密码还需配置
masterauth password
```


细节：

- 主机只可以写，从机只能读（从机只有只读权限）
- 目前没有配置哨兵，主机如果挂掉，那集群就没有了主机，只要主机恢复，那集群就完全恢复，从机挂掉再重启还是能拿到主机的全量数据（）。


复制原理：

Slave启动成功连接到Master后会发送一个sync命令

Master接到命令，启动后台的存盘进程，同时收集所有接收到的用于修改数据集的命令，在后台进程执行完毕后，master将传送整个数据文件到slave，并完成一次完全同步。

全量复制：slave在接收到主机的数据文件后，将其存盘并加载到内存中（只在某些特殊时刻执行，比如slave重新连到master的时候）

增量复制：master继续将新的所有收集到的修改命令一次传给slave，完成同步（增量复制是一直持续进行的）。

但只要重新连接master，一次完全同步（全量复制）将被自动执行
